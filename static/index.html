<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>Truhlik Relé Control</title>
    <style>
        :root {
            color-scheme: light dark;
        }

        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            background: #f5f5f7;
            color: #222;
            margin: 0;
            padding: env(safe-area-inset-top) 16px env(safe-area-inset-bottom);
            -webkit-text-size-adjust: 100%;
        }

        .container {
            max-width: 560px;
            margin: 0 auto;
            padding: 16px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin: 12px 0 16px;
            font-size: clamp(20px, 6vw, 28px);
        }

        .relay-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }

        @media (min-width: 480px) {
            .relay-container {
                grid-template-columns: 1fr 1fr;
            }
        }

        button.relay {
            width: 100%;
            padding: clamp(14px, 4vw, 18px);
            font-size: clamp(16px, 4.5vw, 20px);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.02s ease, background-color 0.2s ease, box-shadow 0.2s ease;
            min-height: 48px; /* mobile touch target */
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.06);
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        button.relay:active {
            transform: scale(0.98);
        }

        button.relay:focus-visible {
            outline: 2px solid #2684ff;
            outline-offset: 2px;
        }

        button.relay.on {
            background-color: #2e7d32;
            color: white;
        }

        button.relay.off {
            background-color: #e6e6e6;
            color: #222;
        }

        @media (prefers-color-scheme: dark) {
            body {
                background: #0f0f0f;
                color: #eaeaea;
            }

            h1 {
                color: #eaeaea;
            }

            button.relay.off {
                background: #2a2a2a;
                color: #eaeaea;
            }

            button.relay.on {
                background: #1b5e20;
            }
        }
    </style>
    <style>
        table.sched { width:100%; border-collapse: collapse; }
        table.sched th, table.sched td { padding:8px; border-bottom:1px solid rgba(0,0,0,0.08); vertical-align: top; }
        .sched-buttons { display:flex; flex-wrap: wrap; gap:6px; }
        .sched-btn { padding:6px 10px; border-radius:8px; border:1px solid #ccc; background:#f8f8f8; cursor:pointer; font-size:14px; }
        .sched-btn.disabled { opacity:0.5; text-decoration: line-through; }
        .sched-btn.active { border-color:#2e7d32; background:#e8f5e9; }
        @media (prefers-color-scheme: dark) {
            table.sched th, table.sched td { border-bottom:1px solid rgba(255,255,255,0.1); }
            .sched-btn { background:#1f1f1f; border-color:#3a3a3a; color:#eaeaea; }
            .sched-btn.active { border-color:#74d680; background:#163b19; }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Truhlik Relé</h1>
    <div class="relay-container" id="relayContainer" role="group" aria-label="Ovládání relé">
        <!-- Buttons are rendered dynamically based on API response -->
    </div>

    <!-- Tabulka rozvrhů (plánů) -->
    <div style="margin-top:16px">
        <h2 style="font-size:18px;margin:10px 0">Rozvrhy</h2>
        <div id="scheduleTableWrapper"></div>
    </div>

<!--    &lt;!&ndash; Manuální kontrola rozvrhu &ndash;&gt;-->
<!--    <div style="margin-top:16px">-->
<!--        <button id="checkScheduleBtn" type="button" style="padding:10px 14px;border-radius:10px;border:none;background:#1976d2;color:#fff;cursor:pointer;box-shadow:0 1px 2px rgba(0,0,0,0.06)">Zkontrolovat rozvrh</button>-->
<!--        <pre id="checkScheduleResult" style="white-space:pre-wrap;background:#f0f0f0;color:#222;padding:10px;border-radius:8px;margin-top:10px;min-height:24px;overflow:auto;max-height:260px"></pre>-->
<!--    </div>-->
</div>

<script>

    // Funkce pro nastavení třídy on/off
    function updateButton(btn, { id, status, description } = status_obj) {
        const isOn = status;
        btn.classList.toggle('on', isOn);
        btn.classList.toggle('off', !isOn);
        btn.setAttribute('aria-pressed', isOn ? 'true' : 'false');
        btn.setAttribute("data-id", id)
        btn.innerHTML = description
    }

    let lastStamp = 0; // UTC ms, 0 initially

    function renderScheduleTable(relays) {
        const wrapper = document.getElementById('scheduleTableWrapper');
        if (!wrapper) return;
        const table = document.createElement('table');
        table.className = 'sched';
        const thead = document.createElement('thead');
        thead.innerHTML = '<tr><th style="width:30%">Relé</th><th>Časové úseky</th></tr>';
        const tbody = document.createElement('tbody');
        relays.forEach((r, rIdx) => {
            const tr = document.createElement('tr');
            const th = document.createElement('th');
            th.textContent = r.description || ('Relé ' + r.id);
            tr.appendChild(th);
            const td = document.createElement('td');
            const box = document.createElement('div');
            box.className = 'sched-buttons';
            if (Array.isArray(r.schedule)) {
                r.schedule.forEach((sp, sIdx) => {
                    const b = document.createElement('button');
                    b.type = 'button';
                    b.className = 'sched-btn';
                    b.textContent = `${sp.on ?? '?'}—${sp.off ?? '?'}`;
                    if (sp.active_now) b.classList.add('active');
                    if (sp.disabled) b.classList.add('disabled');
                    b.addEventListener('click', async () => {
                        try {
                            // Toggle disabled -> is_on becomes !disabled
                            const is_on = sp.disabled;
                            const res = await fetch(`/relay/${r.id}/update_schedule?span_index=${sIdx}&is_on=${is_on ? 'true' : 'false'}`, { method: 'POST' });
                            if (res.ok) {
                                const data = await res.json();
                                if (typeof data.last === 'number') lastStamp = data.last;
                                // Force refresh to bypass 304 and re-render immediately on this device
                                await fetchRelays(true);
                            } else {
                                console.error('Failed to update schedule span', await res.text());
                            }
                        } catch (e) {
                            console.error('Schedule toggle error', e);
                        }
                    });
                    box.appendChild(b);
                });
            }
            td.appendChild(box);
            tr.appendChild(td);
            tbody.appendChild(tr);
        });
        table.appendChild(thead);
        table.appendChild(tbody);
        wrapper.innerHTML = '';
        wrapper.appendChild(table);
    }

    const relayButtons = new Map(); // relay_id -> button

    function renderRelayButtonsIfNeeded(relays) {
        const container = document.getElementById('relayContainer');
        if (!container) return;
        if (relayButtons.size > 0) return; // already rendered for this session
        relays.forEach((state) => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'relay off';
            btn.setAttribute('data-id', String(state.id));
            // initialize label and classes
            updateButton(btn, state);
            btn.addEventListener('click', () => {
                const isOn = btn.classList.contains('on');
                toggleRelay(btn, isOn);
            });
            relayButtons.set(state.id, btn);
            container.appendChild(btn);
        });
    }

    async function fetchRelays(force = false) {
        try {
            const url = force ? '/relays' : `/relays?last=${encodeURIComponent(lastStamp)}`;
            const res = await fetch(url);
            if (!force && res.status === 304) {
                return;
            }
            const payload = await res.json();
            if (payload && typeof payload.last === 'number' && Array.isArray(payload.relays)) {
                renderRelayButtonsIfNeeded(payload.relays);
                lastStamp = payload.last;
                payload.relays.forEach((state) => {
                    const btn = relayButtons.get(state.id);
                    if (btn) updateButton(btn, state);
                });
                renderScheduleTable(payload.relays);
            }
        } catch (err) {
            console.error("Chyba při načítání relé:", err);
        }
    }

    async function toggleRelay(btn, currentState) {
        try {
            const relayId = btn.getAttribute("data-id")

            const res = await fetch(`/relay/${relayId}/set_status?is_on=${!currentState}&last=${encodeURIComponent(lastStamp)}`, {
                method: 'POST'
            });
            const data = await res.json();
            if (typeof data.last === 'number') {
                lastStamp = data.last;
            }
            if (data.state !== undefined) {
                updateButton(btn, data.state);
            }
        } catch (err) {
            console.error("Chyba při změně relé:", err);
        }
    }

    // --- Manuální volání kontroly rozvrhu ---
    const checkBtn = document.getElementById('checkScheduleBtn');
    const checkOut = document.getElementById('checkScheduleResult');
    if (checkBtn && checkOut) {
        checkBtn.addEventListener('click', async () => {
            checkBtn.disabled = true;
            const originalText = checkBtn.textContent;
            checkBtn.textContent = 'Kontroluji…';
            checkOut.textContent = '';
            try {
                const res = await fetch('/check_schedule', { method: 'POST' });
                const text = await res.text();
                // Try JSON pretty print; fallback to raw text
                try {
                    const json = JSON.parse(text);
                    checkOut.textContent = JSON.stringify(json, null, 2);
                } catch (_) {
                    checkOut.textContent = text;
                }
            } catch (e) {
                checkOut.textContent = 'Chyba při volání rozvrhu: ' + (e?.message || e);
            } finally {
                checkBtn.disabled = false;
                checkBtn.textContent = originalText;
            }
        });
    }

    // Periodic refresh
    setInterval(() => fetchRelays(false), 5000);

    // Inicializace
    fetchRelays(true);
</script>
</body>
</html>
