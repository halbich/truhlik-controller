<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>Truhlik Relé Control</title>
    <base href="http://rp.local:8081/">
    <style>
        :root {
            color-scheme: light dark;
        }

        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            background: #f5f5f7;
            color: #222;
            margin: 0;
            padding: env(safe-area-inset-top) 16px env(safe-area-inset-bottom);
            -webkit-text-size-adjust: 100%;
        }

        .container {
            max-width: 560px;
            margin: 0 auto;
            padding: 16px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin: 12px 0 16px;
            font-size: clamp(20px, 6vw, 28px);
        }

        .relay-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }

        @media (min-width: 480px) {
            .relay-container {
                grid-template-columns: 1fr 1fr;
            }
        }

        button.relay {
            width: 100%;
            padding: clamp(14px, 4vw, 18px);
            font-size: clamp(16px, 4.5vw, 20px);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.02s ease, background-color 0.2s ease, box-shadow 0.2s ease;
            min-height: 48px; /* mobile touch target */
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.06);
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        button.relay:active {
            transform: scale(0.98);
        }

        button.relay:focus-visible {
            outline: 2px solid #2684ff;
            outline-offset: 2px;
        }

        button.relay.on {
            background-color: #2e7d32;
            color: white;
        }

        button.relay.off {
            background-color: #e6e6e6;
            color: #222;
        }

        @media (prefers-color-scheme: dark) {
            body {
                background: #0f0f0f;
                color: #eaeaea;
            }

            h1 {
                color: #eaeaea;
            }

            button.relay.off {
                background: #2a2a2a;
                color: #eaeaea;
            }

            button.relay.on {
                background: #1b5e20;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Truhlik Relé</h1>
    <div class="relay-container" role="group" aria-label="Ovládání relé">
        <button class="relay off" id="relay1" type="button" aria-pressed="false">Relé 1</button>
        <button class="relay off" id="relay2" type="button" aria-pressed="false">Relé 2</button>
        <button class="relay off" id="relay3" type="button" aria-pressed="false">Relé 3</button>
        <button class="relay off" id="relay4" type="button" aria-pressed="false">Relé 4</button>
        <button class="relay off" id="relay5" type="button" aria-pressed="false">Relé 5</button>
        <button class="relay off" id="relay6" type="button" aria-pressed="false">Relé 6</button>
        <button class="relay off" id="relay7" type="button" aria-pressed="false">Relé 7</button>
    </div>
</div>

<script>

    // Funkce pro nastavení třídy on/off
    function updateButton(btn, { id, status, description } = status_obj) {
        const isOn = status;
        btn.classList.toggle('on', isOn);
        btn.classList.toggle('off', !isOn);
        btn.setAttribute('aria-pressed', isOn ? 'true' : 'false');
        btn.setAttribute("data-id", id)
        btn.innerHTML = description
    }

    let lastStamp = 0; // UTC ms, 0 initially

    async function fetchRelays() {
        try {
            const res = await fetch(`/relays?last=${encodeURIComponent(lastStamp)}`);
            if (res.status === 304) {
                // No changes, do not update DOM
                return;
            }
            const payload = await res.json();
            if (payload && typeof payload.last === 'number' && Array.isArray(payload.relays)) {
                lastStamp = payload.last;
                payload.relays.forEach((state, idx) => updateButton(document.getElementById(`relay${idx + 1}`), state));
            }
        } catch (err) {
            console.error("Chyba při načítání relé:", err);
        }
    }

    async function toggleRelay(btn, currentState) {
        try {
            const relayId = btn.getAttribute("data-id")

            const res = await fetch(`/relay/${relayId}/set_status?is_on=${!currentState}&last=${encodeURIComponent(lastStamp)}`, {
                method: 'POST'
            });
            const data = await res.json();
            if (typeof data.last === 'number') {
                lastStamp = data.last;
            }
            if (data.state !== undefined) {
                updateButton(btn, data.state);
            }
        } catch (err) {
            console.error("Chyba při změně relé:", err);
        }
    }


    // Připojení onclick handlerů na tlačítka
    for (let i = 1; i <= 7; i++) {
        const btn = document.getElementById(`relay${i}`);
        btn.addEventListener('click', () => {
            const isOn = btn.classList.contains('on');
            toggleRelay(btn, isOn);
        });
    }

    setInterval(fetchRelays, 5000)

    // Inicializace
    fetchRelays();
</script>
</body>
</html>
