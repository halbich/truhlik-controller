<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>Truhlik Relé Control</title>
    <base href="http://rp.local:8081/">
    <style>
        :root {
            color-scheme: light dark;
        }

        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            background: #f5f5f7;
            color: #222;
            margin: 0;
            padding: env(safe-area-inset-top) 16px env(safe-area-inset-bottom);
            -webkit-text-size-adjust: 100%;
        }

        .container {
            max-width: 560px;
            margin: 0 auto;
            padding: 16px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin: 12px 0 16px;
            font-size: clamp(20px, 6vw, 28px);
        }

        .relay-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }

        @media (min-width: 480px) {
            .relay-container {
                grid-template-columns: 1fr 1fr;
            }
        }

        button.relay {
            width: 100%;
            padding: clamp(14px, 4vw, 18px);
            font-size: clamp(16px, 4.5vw, 20px);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.02s ease, background-color 0.2s ease, box-shadow 0.2s ease;
            min-height: 48px; /* mobile touch target */
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.06);
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        button.relay:active {
            transform: scale(0.98);
        }

        button.relay:focus-visible {
            outline: 2px solid #2684ff;
            outline-offset: 2px;
        }

        button.relay.on {
            background-color: #2e7d32;
            color: white;
        }

        button.relay.off {
            background-color: #e6e6e6;
            color: #222;
        }

        @media (prefers-color-scheme: dark) {
            body {
                background: #0f0f0f;
                color: #eaeaea;
            }

            h1 {
                color: #eaeaea;
            }

            button.relay.off {
                background: #2a2a2a;
                color: #eaeaea;
            }

            button.relay.on {
                background: #1b5e20;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Truhlik Relé</h1>
    <table id="relayTable" style="width:100%;border-collapse:collapse">
        <thead>
        <tr>
            <th style="text-align:left;padding:8px">Relé</th>
            <th style="text-align:left;padding:8px">Časové úseky</th>
        </tr>
        </thead>
        <tbody id="relayTbody"></tbody>
    </table>
    <!-- Manuální kontrola rozvrhu -->
    <div style="margin-top:16px">
        <button id="checkScheduleBtn" type="button" style="padding:10px 14px;border-radius:10px;border:none;background:#1976d2;color:#fff;cursor:pointer;box-shadow:0 1px 2px rgba(0,0,0,0.06)">Zkontrolovat rozvrh</button>
        <pre id="checkScheduleResult" style="white-space:pre-wrap;background:#f0f0f0;color:#222;padding:10px;border-radius:8px;margin-top:10px;min-height:24px;overflow:auto;max-height:260px"></pre>
    </div>
</div>

<script>

    // Render řádků relé a tlačítek časových úseků
    function renderRelayTable(relays) {
        const tbody = document.getElementById('relayTbody');
        tbody.innerHTML = '';
        relays.forEach(relay => {
            const tr = document.createElement('tr');
            const tdName = document.createElement('td');
            tdName.style.padding = '8px';
            tdName.textContent = relay.description || `Relé ${relay.id}`;

            const tdSpans = document.createElement('td');
            tdSpans.style.padding = '8px';

            if (Array.isArray(relay.spans) && relay.spans.length > 0) {
                relay.spans.forEach((span, idx) => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.style.margin = '0 6px 6px 0';
                    btn.style.padding = '8px 10px';
                    btn.style.borderRadius = '10px';
                    btn.style.border = 'none';
                    btn.style.cursor = 'pointer';
                    btn.dataset.relayId = relay.id;
                    btn.dataset.spanIndex = String(idx);

                    const isDisabled = !!span.disabled;
                    const isActiveNow = !!span.active_now;

                    btn.textContent = `${span.on || '?'}–${span.off || '?'}${isDisabled ? ' (vyp.)' : ''}`;
                    // Color coding: active_now = green, otherwise gray; disabled dimmed
                    if (isActiveNow && !isDisabled) {
                        btn.style.background = '#2e7d32';
                        btn.style.color = '#fff';
                    } else {
                        btn.style.background = '#e6e6e6';
                        btn.style.color = '#222';
                    }
                    if (isDisabled) {
                        btn.style.opacity = '0.5';
                    }

                    btn.addEventListener('click', async () => {
                        const newIsOn = isDisabled; // clicking toggles: if disabled -> enable (is_on=true); if enabled -> disable (is_on=false)
                        await updateScheduleSpan(relay.id, idx, newIsOn);
                    });

                    tdSpans.appendChild(btn);
                });
            } else {
                const span = document.createElement('span');
                span.textContent = 'Žádné časové úseky';
                tdSpans.appendChild(span);
            }

            tr.appendChild(tdName);
            tr.appendChild(tdSpans);
            tbody.appendChild(tr);
        });
    }

    let lastStamp = 0; // UTC ms, 0 initially

    async function fetchRelays() {
        try {
            const res = await fetch(`/relays?last=${encodeURIComponent(lastStamp)}`);
            if (res.status === 304) {
                return;
            }
            const payload = await res.json();
            if (payload && typeof payload.last === 'number' && Array.isArray(payload.relays)) {
                lastStamp = payload.last;
                renderRelayTable(payload.relays);
            }
        } catch (err) {
            console.error("Chyba při načítání relé:", err);
        }
    }

    async function updateScheduleSpan(relayId, spanIndex, isOn) {
        try {
            const res = await fetch(`/relay/${encodeURIComponent(relayId)}/update_schedule?span_index=${encodeURIComponent(spanIndex)}&is_on=${encodeURIComponent(isOn)}`, { method: 'POST' });
            const data = await res.json();
            if (typeof data.last === 'number') {
                lastStamp = data.last;
            }
            // Vždy po změně načti znovu relays, aby se přerenderovala tabulka
            await fetchRelays();
        } catch (err) {
            console.error('Chyba při aktualizaci rozvrhu:', err);
        }
    }

    // --- Manuální volání kontroly rozvrhu ---
    const checkBtn = document.getElementById('checkScheduleBtn');
    const checkOut = document.getElementById('checkScheduleResult');
    if (checkBtn && checkOut) {
        checkBtn.addEventListener('click', async () => {
            checkBtn.disabled = true;
            const originalText = checkBtn.textContent;
            checkBtn.textContent = 'Kontroluji…';
            checkOut.textContent = '';
            try {
                const res = await fetch('/check_schedule', { method: 'POST' });
                const text = await res.text();
                // Try JSON pretty print; fallback to raw text
                try {
                    const json = JSON.parse(text);
                    checkOut.textContent = JSON.stringify(json, null, 2);
                } catch (_) {
                    checkOut.textContent = text;
                }
            } catch (e) {
                checkOut.textContent = 'Chyba při volání rozvrhu: ' + (e?.message || e);
            } finally {
                checkBtn.disabled = false;
                checkBtn.textContent = originalText;
            }
        });
    }

    // Periodické získávání dat relé (včetně časových úseků) a rerender tabulky
    setInterval(fetchRelays, 5000)

    // Inicializace
    fetchRelays();
</script>
</body>
</html>
